import{b as Te,_ as at}from"../chunks/BRVk3zM3.js";import{f as C,a as x,c as re,e as V}from"../chunks/DZs8rR8k.js";import"../chunks/D2htM9l8.js";import{o as st}from"../chunks/CSfjm-6H.js";import{p as ot,l as ae,c as nt,g as e,d as ct,e as i,s as g,f,m as w,r as c,n as he,t as it,i as dt,j as se,k as F,u as v,o as X,q as oe}from"../chunks/B4RuN_dZ.js";import{s as A}from"../chunks/Bwak9JMZ.js";import{i as R}from"../chunks/B2LozDeQ.js";import{e as De,i as Me}from"../chunks/dk5Fz5Mq.js";import{r as Pe,s as Ie,a as ze}from"../chunks/C6Um85Qa.js";import{b as Ge}from"../chunks/Gaoq9xH0.js";import{i as lt}from"../chunks/D_xYtrhe.js";import{g as ft,a as ut}from"../chunks/M8vgo97S.js";var pt=C('<div class="flex items-center justify-center" style="height: 600px;"><div class="text-center"><div class="mx-auto mb-4 h-8 w-8 animate-spin rounded-full border-4 border-primary-500 border-t-transparent"></div> <p class="text-surface-600-300-token">Loading architecture data...</p></div></div>'),vt=C('<div class="flex items-center justify-center" style="height: 600px;"><div class="text-center"><p class="mb-2 text-error-500">Failed to load architecture data</p> <p class="text-surface-600-300-token text-sm"> </p> <button class="mt-4 btn preset-filled-primary-500">Retry</button></div></div>'),ht=C('<div class="flex items-center justify-center" style="height: 600px;"><div class="text-center"><p class="text-surface-600-300-token">No services found</p> <p class="mt-2 text-sm text-surface-500">Add some services to see the architecture graph</p></div></div>'),_t=C('<div style="height: 600px; overflow: hidden;"></div>'),gt=C('<div class="mt-2 flex items-center justify-end gap-2"><span class="text-surface-600-300-token text-sm">Showing connections between <strong> </strong> and <strong> </strong></span> <button type="button" class="btn preset-tonal btn-sm" title="Clear filter">âœ•</button></div>'),mt=C('<a class="anchor font-mono text-xs hover:underline"> </a>'),yt=C('<span class="font-mono text-xs"> </span>'),bt=C('<a class="anchor font-mono text-xs hover:underline"> </a>'),xt=C('<span class="font-mono text-xs"> </span>'),wt=C("<tr><td> </td><td> </td><td> </td><td><!></td><td><!></td></tr>"),Nt=C('<tr><td> </td><td> </td><td> </td><td><span class="text-surface-500">None</span></td><td><span class="text-surface-500">None</span></td></tr>'),St=C('<div class="space-y-6 p-6"><div class="flex items-center justify-between"><div><h1 class="h3">Architecture</h1></div></div> <div class="card p-4"><!></div> <div class="mt-2 flex items-center justify-between"><div class="text-surface-600-300-token text-sm"><p>Click on links in the graph to filter the table below. Hold CTRL and scroll to zoom.</p></div> <div class="flex items-center gap-4"><label class="flex cursor-pointer items-center gap-2"><input type="checkbox" class="checkbox"/> <span class="text-sm">HTTP Connections</span></label> <label class="flex cursor-pointer items-center gap-2"><input type="checkbox" class="checkbox"/> <span class="text-sm">Event Connections</span></label></div></div> <!> <div class="app-card"><div class="p-6"><div class="mb-4"><h1 class="h4">Service Connections</h1></div> <div class="table-container"><table class="app-table"><thead><tr><th>Type</th><th>Source</th><th>Destination</th><th>Source Handler</th><th>Destination Handler</th></tr></thead><tbody></tbody></table></div></div></div></div>');function Ut(Ue,Fe){ot(Fe,!1);const ne=w(),_e=w(),J=w();let I=w(),z=w(null),ce=w(!0),W=w(null),y=w({nodes:[],links:[]});function He(r,a){const d=r.map(o=>({id:o.name,name:o.name})),p=new Map,N=o=>o?o.type==="http"||o.type==="grpc"?`${o.method||""} ${o.path}`.trim():o.path||o.function_name||"Unknown":"Unknown";a.forEach(o=>{const h=o.source_service_name,l=o.dest_service_name,u=o.dest_handler?.type||o.source_handler?.type||"unknown",b=`${h}->${l}->${u}`,n={source_handler:{id:o.source_handler?.id||0,service_id:o.source_service_id,type:o.source_handler?.type||"unknown",name:N(o.source_handler)},dest_handler:{id:o.dest_handler?.id||0,service_id:o.dest_service_id,type:o.dest_handler?.type||"unknown",name:N(o.dest_handler)}};p.has(b)?p.get(b).values.push(n):p.set(b,{source:h,target:l,type:u,values:[n]})});const t=Array.from(p.values()),s=new Set;return t.forEach(o=>{const h=`${o.source}->${o.target}`,l=`${o.target}->${o.source}`;s.has(l)&&(o.curvature=.2,t.forEach(u=>{u.source===o.target&&u.target===o.source&&(u.curvature=.2)})),s.add(h)}),{nodes:d,links:t}}async function Oe(){f(ce,!0),f(W,null);try{const[r,a]=await Promise.all([ft(),ut("/links")]);f(y,He(r,a))}catch(r){f(W,r instanceof Error?r.message:"Failed to load data"),console.error("Error fetching graph data:",r)}finally{f(ce,!1)}}const T=new Set,D=new Set;let ge=null,H=w(null),q=w(null);const S=new Set,L=new Set;let m=w(new Map),ee=w(),K=w(!0),Y=w(!0),G=w(null),U=w(null);function ke(){f(G,null),f(U,null)}function Re(){f(m,new Map(e(y).nodes.map(r=>[r.id,r]))),e(y).nodes.forEach(r=>{r.neighbors=[],r.links=[]}),e(y).links.forEach(r=>{const a=typeof r.source=="object"?r.source:e(m).get(r.source),d=typeof r.target=="object"?r.target:e(m).get(r.target);!a||!d||(a.neighbors.push(d),d.neighbors.push(a),(a.links||(a.links=[])).push(r),(d.links||(d.links=[])).push(r))})}async function me(){await Oe(),!(e(W)||e(y).nodes.length===0)&&(Re(),await it(),await Be())}st(async()=>{await me()});function qe(r,a,d){r&&(a.add(r),Array.isArray(r.neighbors)&&r.neighbors.forEach(p=>a.add(p)),Array.isArray(r.links)&&r.links.forEach(p=>d.add(p)))}function Ke(r){S.clear(),L.clear(),f(H,r||null),qe(e(H),S,L)}function ye(){return"architecture-graph-positions"}function Ye(){if(!e(z)||!e(y))return;const r={};e(y).nodes.forEach(a=>{a.x!==void 0&&a.y!==void 0&&(r[a.id]={x:a.x,y:a.y})});try{localStorage.setItem(ye(),JSON.stringify(r)),console.log(`Saved positions for ${Object.keys(r).length} nodes`)}catch(a){console.error("Failed to save node positions:",a)}}function $e(){try{const r=localStorage.getItem(ye());if(r){const a=JSON.parse(r);return console.log(`Loaded positions for ${Object.keys(a).length} nodes`),a}}catch(r){console.error("Failed to load node positions:",r)}return null}async function Be(){try{const a=(await at(()=>import("../chunks/iN_cEwNE.js"),[],import.meta.url)).default;e(I)&&dt(I,e(I).innerHTML="");const d=$e();let p=!1;d&&e(y).nodes.forEach(t=>{const s=d[t.id];s&&(t.x=s.x,t.y=s.y,t.fx=s.x,t.fy=s.y,p=!0)}),f(z,new a(e(I))),e(z).graphData(e(J)).nodeId("id").nodeVal("val").nodeLabel("name").linkSource("source").linkTarget("target").width(e(I).clientWidth).height(600).zoom(6).enableZoomInteraction(!1).enablePanInteraction(!0).onNodeHover(t=>{T.clear(),D.clear(),t&&(T.add(t),t.neighbors.forEach(s=>T.add(s)),t.links.forEach(s=>D.add(s))),S.forEach(s=>T.add(s)),L.forEach(s=>D.add(s)),ge=t||null}).onLinkHover(t=>{if(T.clear(),D.clear(),t){D.add(t);const s=typeof t.source=="object"?t.source:e(m).get(t.source),o=typeof t.target=="object"?t.target:e(m).get(t.target);s&&T.add(s),o&&T.add(o)}S.forEach(s=>T.add(s)),L.forEach(s=>D.add(s))}).onNodeClick(t=>{Ke(t),f(H,t),f(q,null)}).onLinkClick(t=>{f(q,t),f(H,null),S.clear(),L.clear(),L.add(t);const s=typeof t.source=="object"?t.source:e(m).get(t.source),o=typeof t.target=="object"?t.target:e(m).get(t.target);s&&S.add(s),o&&S.add(o),f(G,s?.id||null),f(U,o?.id||null),e(ee)&&setTimeout(()=>{e(ee).scrollIntoView({behavior:"smooth",block:"start"})},100)}).onNodeDragEnd(t=>{t.fx=t.x,t.fy=t.y,Ye()}).autoPauseRedraw(!1).linkWidth(t=>D.has(t)?2:1).linkColor(t=>D.has(t)?"#fff":"#aaaaaa").linkDirectionalArrowLength(t=>6).linkDirectionalArrowRelPos(1).linkLineDash(t=>{const s=t.type||"";return s==="http"||s==="grpc"?null:[3,2]}).nodeColor(t=>{if(T.has(t)){const s=ge||e(H);if(t===s)return"white"}return"#4DB6AC"}).nodeCanvasObjectMode(()=>"after").nodeCanvasObject((t,s,o)=>{const h=t.name||"unknown",l=12/o;s.font=l+"px Sans-Serif",s.textAlign="center",s.textBaseline="top",s.fillStyle="#fff",s.fillText(h,t.x,t.y+8)}).linkCurvature("curvature").linkCanvasObjectMode(()=>"after").linkCanvasObject((t,s,o)=>{const h=t.type||"";if(!h)return;const l=typeof t.source=="object"?t.source:e(m).get(t.source),u=typeof t.target=="object"?t.target:e(m).get(t.target);if(!l||!u)return;const b=14/o;s.font=`${b}px Sans-Serif`,s.textAlign="center",s.textBaseline="middle",s.fillStyle=D.has(t)?"#fff":"#aaaaaa";const n=u.x-l.x,j=u.y-l.y,M=Math.sqrt(n*n+j*j);if(M===0)return;const P=t.curvature||0,$=(l.x+u.x)/2,B=(l.y+u.y)/2;let Z,O;if(Math.abs(P)<.01)Z=$,O=B;else{const pe=j/M,Q=-n/M,te=P*M*.5;Z=$+pe*te,O=B+Q*te}s.fillText(h,Z,O)});const N=e(I).querySelector("canvas");N&&N.addEventListener("wheel",t=>{if(t.ctrlKey){t.preventDefault();const s=1+Math.sign(t.deltaY)*-.1,o=e(z).zoom();e(z).zoom(o*s,0)}},{passive:!1}),console.log("Graph initialized successfully")}catch(r){console.error("Error initializing graph:",r)}}ae(()=>(e(y),e(K),e(Y)),()=>{f(ne,e(y).links.filter(r=>!(!e(K)&&(r.type==="http"||r.type==="grpc")||!e(Y)&&r.type==="kafka")))}),ae(()=>(e(y),e(K),e(Y),e(G),e(U)),()=>{f(_e,e(y).links.filter(r=>{const a=typeof r.source=="object"?r.source.id:r.source,d=typeof r.target=="object"?r.target.id:r.target;return!e(K)&&(r.type==="http"||r.type==="grpc")||!e(Y)&&r.type==="kafka"?!1:e(G)&&e(U)?a===e(G)&&d===e(U):!0}))}),ae(()=>(e(y),e(ne)),()=>{f(J,{nodes:e(y).nodes,links:e(ne)})}),ae(()=>(e(z),e(J)),()=>{e(z)&&e(J)&&e(z).graphData(e(J))}),nt(),lt();var ie=St(),de=g(i(ie),2),Ve=i(de);{var Xe=r=>{var a=pt();x(r,a)},Je=r=>{var a=re(),d=se(a);{var p=t=>{var s=vt(),o=i(s),h=g(i(o),2),l=i(h,!0);c(h);var u=g(h,2);c(o),c(s),F(()=>A(l,e(W))),V("click",u,me),x(t,s)},N=t=>{var s=re(),o=se(s);{var h=u=>{var b=ht();x(u,b)},l=u=>{var b=_t();Te(b,n=>f(I,n),()=>e(I)),x(u,b)};R(o,u=>{e(y),v(()=>e(y).nodes.length===0)?u(h):u(l,!1)},!0)}x(t,s)};R(d,t=>{e(W)?t(p):t(N,!1)},!0)}x(r,a)};R(Ve,r=>{e(ce)?r(Xe):r(Je,!1)})}c(de);var le=g(de,2),be=g(i(le),2),fe=i(be),xe=i(fe);Pe(xe),he(2),c(fe);var we=g(fe,2),Ne=i(we);Pe(Ne),he(2),c(we),c(be),c(le);var Se=g(le,2);{var We=r=>{const a=oe(()=>(e(m),e(G),v(()=>e(m).get(e(G))))),d=oe(()=>(e(m),e(U),v(()=>e(m).get(e(U)))));var p=gt(),N=i(p),t=g(i(N)),s=i(t,!0);c(t);var o=g(t,2),h=i(o,!0);c(o),c(N);var l=g(N,2);c(p),F(()=>{A(s,(X(e(a)),v(()=>e(a)?.name||"Unknown"))),A(h,(X(e(d)),v(()=>e(d)?.name||"Unknown")))}),V("click",l,ke),x(r,p)};R(Se,r=>{e(G)&&e(U)&&r(We)})}var ue=g(Se,2),je=i(ue),Ee=g(i(je),2),Ae=i(Ee),Ce=g(i(Ae));De(Ce,5,()=>e(_e),Me,(r,a)=>{const d=oe(()=>(e(a),e(m),v(()=>typeof e(a).source=="object"?e(a).source:e(m).get(e(a).source)))),p=oe(()=>(e(a),e(m),v(()=>typeof e(a).target=="object"?e(a).target:e(m).get(e(a).target))));var N=re(),t=se(N);{var s=h=>{var l=re(),u=se(l);De(u,1,()=>(e(a),v(()=>e(a).values)),Me,(b,n)=>{var j=wt();let M;var P=i(j),$=i(P,!0);c(P);var B=g(P),Z=i(B,!0);c(B);var O=g(B),pe=i(O,!0);c(O);var Q=g(O),te=i(Q);{var Ze=E=>{var _=mt(),k=i(_,!0);c(_),F(()=>{ze(_,"href",`/services/${e(n),v(()=>e(n).source_handler.service_id)??""}?highlight_handler_id=${e(n),v(()=>e(n).source_handler.id)??""}`),A(k,(e(n),v(()=>e(n).source_handler?.name||"N/A")))}),V("click",_,ve=>ve.stopPropagation()),x(E,_)},Qe=E=>{var _=yt(),k=i(_,!0);c(_),F(()=>A(k,(e(n),v(()=>e(n).source_handler?.name||"N/A")))),x(E,_)};R(te,E=>{e(n),v(()=>e(n).source_handler?.service_id&&e(n).source_handler?.id)?E(Ze):E(Qe,!1)})}c(Q);var Le=g(Q),et=i(Le);{var tt=E=>{var _=bt(),k=i(_,!0);c(_),F(()=>{ze(_,"href",`/services/${e(n),v(()=>e(n).dest_handler.service_id)??""}?highlight_handler_id=${e(n),v(()=>e(n).dest_handler.id)??""}`),A(k,(e(n),v(()=>e(n).dest_handler?.name||"N/A")))}),V("click",_,ve=>ve.stopPropagation()),x(E,_)},rt=E=>{var _=xt(),k=i(_,!0);c(_),F(()=>A(k,(e(n),v(()=>e(n).dest_handler?.name||"N/A")))),x(E,_)};R(et,E=>{e(n),v(()=>e(n).dest_handler?.service_id&&e(n).dest_handler?.id)?E(tt):E(rt,!1)})}c(Le),c(j),F(()=>{M=Ie(j,1,"cursor-pointer",null,M,{"bg-surface-700":e(q)===e(a)}),A($,(e(a),v(()=>e(a).type||"Unknown"))),A(Z,(X(e(d)),v(()=>e(d)?.name||"Unknown"))),A(pe,(X(e(p)),v(()=>e(p)?.name||"Unknown")))}),V("click",j,()=>{f(q,e(a)),f(H,null),S.clear(),L.clear(),L.add(e(a)),e(d)&&S.add(e(d)),e(p)&&S.add(e(p))}),x(b,j)}),x(h,l)},o=h=>{var l=Nt();let u;var b=i(l),n=i(b,!0);c(b);var j=g(b),M=i(j,!0);c(j);var P=g(j),$=i(P,!0);c(P),he(2),c(l),F(()=>{u=Ie(l,1,"cursor-pointer",null,u,{"bg-surface-700":e(q)===e(a)}),A(n,(e(a),v(()=>e(a).type||"Unknown"))),A(M,(X(e(d)),v(()=>e(d)?.name||"Unknown"))),A($,(X(e(p)),v(()=>e(p)?.name||"Unknown")))}),V("click",l,()=>{f(q,e(a)),f(H,null),S.clear(),L.clear(),L.add(e(a)),e(d)&&S.add(e(d)),e(p)&&S.add(e(p))}),x(h,l)};R(t,h=>{e(a),v(()=>e(a).values&&e(a).values.length>0)?h(s):h(o,!1)})}x(r,N)}),c(Ce),c(Ae),c(Ee),c(je),c(ue),Te(ue,r=>f(ee,r),()=>e(ee)),c(ie),Ge(xe,()=>e(K),r=>f(K,r)),Ge(Ne,()=>e(Y),r=>f(Y,r)),x(Ue,ie),ct()}export{Ut as component};
